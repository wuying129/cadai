<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä½œå“ | å“ç‰Œè§†è§‰å·¥åŠ</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Noto+Serif+SC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'paper': '#F9F7F2', 'paper-light': '#FFFEFA', 'ink': '#2C2420', 'ink-light': '#585350',
                        'gold': '#C68E5D', 'gold-dim': '#AB7F55', 'sage': '#8DA399', 'stone': '#E5E0D8',
                    },
                    fontFamily: { serif: ['"Noto Serif SC"', '"Playfair Display"', 'serif'], sans: ['"Lato"', 'sans-serif'], },
                    boxShadow: { 'layer': '0 10px 30px -10px rgba(44, 36, 32, 0.08)', 'float': '0 20px 40px -10px rgba(44, 36, 32, 0.15)', 'glow': '0 0 20px rgba(198, 142, 93, 0.3)', },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #F9F7F2; color: #2C2420; overflow-x: hidden; }
        .bg-noise { position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0.05; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
        .blob-bg { position: fixed; border-radius: 50%; filter: blur(80px); z-index: 0; opacity: 0.4; animation: blob 10s infinite; }
        @keyframes blob { 0%,100% { transform: translate(0,0) scale(1); } 33% { transform: translate(30px,-50px) scale(1.1); } 66% { transform: translate(-20px,20px) scale(0.9); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-up { animation: fadeUp 0.8s ease-out forwards; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #D1CDC7; border-radius: 3px; }
        .download-btn { transition: all 0.3s; } .download-btn:hover { transform: translateY(-2px); }
        .download-toast { animation: toastIn 0.3s ease-out; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(10px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; } .fade-enter-from, .fade-leave-to { opacity: 0; }
        .stagger-enter-active, .stagger-leave-active { transition: all 0.5s ease; } .stagger-enter-from, .stagger-leave-to { opacity: 0; transform: translateY(20px); }
        [v-cloak] { display: none; }
        .history-item { cursor: pointer; transition: all 0.3s; }
        .history-item:hover { transform: translateY(-4px); box-shadow: 0 20px 40px -10px rgba(44, 36, 32, 0.2); }
    </style>
</head>
<body class="antialiased">
    <div class="bg-noise"></div>
    <div class="blob-bg w-96 h-96 bg-gold/20 -top-[10%] -left-[10%]"></div>
    <div class="blob-bg w-80 h-80 bg-stone/50 bottom-[10%] -right-[5%]"></div>

    <div id="app" v-cloak class="relative z-10 min-h-screen flex flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-50 backdrop-blur-md bg-paper/80 border-b border-stone/50">
            <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
                <div class="w-24">
                    <button @click="goBack" class="group flex items-center gap-2 text-xs font-bold tracking-[0.2em] text-ink-light hover:text-gold transition-colors">
                        <span class="w-8 h-[1px] bg-ink-light group-hover:bg-gold transition-colors"></span>è¿”å›
                    </button>
                </div>
                <h1 class="font-serif text-2xl text-ink font-bold italic">Atelier<span class="text-gold">.</span>AI</h1>
                <div class="flex items-center gap-4">
                    <!-- ç”¨æˆ·çŠ¶æ€ -->
                    <div v-if="currentUser" class="relative user-menu-container">
                        <div @click.stop="showUserMenu = !showUserMenu" class="w-8 h-8 rounded-full bg-gold text-white flex items-center justify-center font-bold text-sm uppercase cursor-pointer hover:ring-2 hover:ring-gold/50 transition-all">{{ currentUser.email.charAt(0) }}</div>
                        <!-- ä¸‹æ‹‰èœå• -->
                        <div v-if="showUserMenu" class="absolute right-0 mt-2 w-36 bg-white rounded-lg shadow-float border border-stone/30 py-1 z-50">
                            <a href="/credits" class="block px-4 py-2 text-sm text-ink hover:bg-stone/20 transition-colors">ç§¯åˆ†ç®¡ç†</a>
                            <div class="border-t border-stone/30 my-1"></div>
                            <button @click="logout" class="w-full text-left px-4 py-2 text-sm text-ink hover:bg-stone/20 transition-colors">é€€å‡ºç™»å½•</button>
                        </div>
                    </div>
                    <a v-else href="/login" class="text-xs text-ink-light hover:text-gold transition-colors">æœªç™»å½•</a>
                </div>
            </div>
        </header>

        <main class="flex-grow flex flex-col items-center justify-start p-6 relative">
            <!-- åˆ—è¡¨è§†å›¾ -->
            <transition name="stagger">
                <div v-if="view === 'list'" class="w-full max-w-7xl">
                    <div class="mb-8 border-b border-ink/10 pb-6">
                        <span class="text-gold text-xs font-bold tracking-[0.2em] uppercase mb-2 block">æˆ‘çš„ä½œå“</span>
                        <h2 class="font-serif text-5xl text-ink">åˆ›ä½œå†ç¨‹</h2>
                        <p class="text-ink-light text-sm mt-2">å…± {{ totalSessions }} ä¸ªé¡¹ç›®</p>
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div v-if="!loading && sessions.length === 0" class="text-center py-20">
                        <div class="text-6xl mb-4">ğŸ“¦</div>
                        <p class="text-ink-light text-lg mb-2">è¿˜æ²¡æœ‰å†å²è®°å½•</p>
                        <a href="/" class="text-gold text-sm hover:underline">å»åˆ›ä½œç¬¬ä¸€ä¸ªä½œå“</a>
                    </div>

                    <!-- åŠ è½½ä¸­ -->
                    <div v-if="loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="i in 6" :key="i" class="animate-pulse">
                            <div class="bg-stone/20 aspect-[4/3] rounded-lg mb-4"></div>
                            <div class="bg-stone/20 h-6 w-2/3 rounded mb-2"></div>
                            <div class="bg-stone/20 h-4 w-1/2 rounded"></div>
                        </div>
                    </div>

                    <!-- é¡¹ç›®åˆ—è¡¨ -->
                    <div v-if="!loading && sessions.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="(session, index) in sessions" :key="session.session_id"
                             @click="viewDetail(session)"
                             class="history-item bg-white rounded-lg shadow-layer overflow-hidden"
                             :style="{ animationDelay: index * 50 + 'ms' }">
                            <div class="aspect-[4/3] bg-stone/10 overflow-hidden">
                                <img v-if="session.cover_image"
                                     :src="session.cover_image"
                                     class="w-full h-full object-cover transition-transform duration-700 hover:scale-110"
                                     loading="lazy">
                                <div v-else class="w-full h-full flex items-center justify-center text-stone text-4xl">
                                    <i class="fas fa-image"></i>
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-serif text-xl text-ink mb-1">{{ session.product_name }}</h3>
                                <div class="flex items-center justify-between text-xs text-ink-light">
                                    <span>{{ session.poster_count }} å¼ æµ·æŠ¥</span>
                                    <span>{{ formatDate(session.created_at) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åŠ è½½æ›´å¤š -->
                    <div v-if="hasMore" class="text-center mt-8">
                        <button @click="loadMore" :disabled="loadingMore"
                                class="px-8 py-3 bg-ink text-white rounded-lg font-bold text-xs uppercase tracking-widest hover:bg-gold hover:shadow-glow transition-all">
                            <span v-if="!loadingMore">åŠ è½½æ›´å¤š</span>
                            <span v-else>åŠ è½½ä¸­...</span>
                        </button>
                    </div>
                </div>
            </transition>

            <!-- è¯¦æƒ…è§†å›¾ -->
            <transition name="stagger">
                <div v-if="view === 'detail' && currentSession" class="w-full max-w-7xl">
                    <div class="flex flex-col md:flex-row items-end justify-between mb-16 px-4 border-b border-ink/10 pb-8">
                        <div>
                            <span class="text-gold text-xs font-bold tracking-[0.2em] uppercase mb-2 block">é¡¹ç›®è¯¦æƒ…</span>
                            <h2 class="font-serif text-5xl text-ink">{{ currentSession.product_name }}</h2>
                            <p class="text-ink-light text-sm mt-2">{{ formatDate(currentSession.created_at) }} Â· å…± {{ currentSession.posters.length }} å¼ æµ·æŠ¥</p>
                        </div>
                        <div class="flex gap-4 mt-6 md:mt-0">
                            <button @click="backToList" class="px-6 py-3 border border-stone rounded hover:border-gold hover:text-gold transition-all text-xs font-bold tracking-widest uppercase">è¿”å›åˆ—è¡¨</button>
                            <button @click="downloadAll" class="px-6 py-3 bg-ink text-white rounded shadow-layer hover:bg-gold hover:shadow-glow transition-all text-xs font-bold tracking-widest uppercase flex items-center gap-2"><i class="fas fa-download"></i> ä¸‹è½½å…¨éƒ¨</button>
                        </div>
                    </div>

                    <!-- æµ·æŠ¥ç½‘æ ¼ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 px-4">
                        <div v-for="(poster, index) in sortedPosters" :key="poster.index" class="group cursor-pointer animate-fade-up" :style="{ animationDelay: index * 100 + 'ms' }">
                            <div class="relative bg-white p-3 pb-8 shadow-layer hover:shadow-float transition-all duration-500 transform group-hover:-translate-y-2 group-hover:ring-1 group-hover:ring-gold/20">
                                <div class="relative overflow-hidden bg-stone/10 aspect-[3/4] mb-4" @click="viewImage(poster)">
                                    <img :src="poster.url" class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110">
                                    <div class="absolute inset-0 bg-ink/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center backdrop-blur-[2px]">
                                        <div class="w-12 h-12 bg-white/90 rounded-full flex items-center justify-center scale-50 group-hover:scale-100 transition-transform hover:text-gold"><i class="fas fa-expand-alt text-ink"></i></div>
                                    </div>
                                    <!-- ç‰ˆæœ¬æ•°é‡å¾½ç«  -->
                                    <div v-if="poster.versionCount > 1" class="absolute top-2 right-2 bg-gold text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-lg flex items-center gap-1">
                                        <i class="fas fa-layer-group text-[8px]"></i>
                                        <span>{{ poster.versionCount }}ä¸ªç‰ˆæœ¬</span>
                                    </div>
                                </div>
                                <div class="px-2">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-[10px] text-stone font-bold border border-stone px-1 rounded">{{ poster.number }}</span>
                                        <button @click.stop="downloadPoster(poster)" class="download-btn flex items-center gap-1.5 px-2 py-1 rounded text-[10px] font-bold text-ink-light hover:text-white hover:bg-gold transition-all"><i class="fas fa-arrow-down text-[8px]"></i><span class="hidden sm:inline">ä¸‹è½½</span></button>
                                    </div>
                                    <h3 class="font-serif text-xl text-ink leading-none mb-1">{{ poster.mainTitle }}</h3>
                                    <p class="text-[10px] text-gold font-bold tracking-widest uppercase">{{ poster.subTitle }}</p>
                                </div>
                                <transition name="fade"><div v-if="poster.showDownloadToast" class="download-toast absolute bottom-2 left-1/2 -translate-x-1/2 bg-ink text-white text-[10px] px-3 py-1.5 rounded-full flex items-center gap-1.5 shadow-lg"><i class="fas fa-check-circle text-green-400"></i>å·²å¼€å§‹ä¸‹è½½</div></transition>
                            </div>
                        </div>
                    </div>
                    <div class="h-20"></div>
                </div>
            </transition>
        </main>

        <!-- Edit Lightbox -->
        <transition name="fade">
            <div v-if="lightbox.isOpen" class="fixed inset-0 z-[100] bg-ink/90 backdrop-blur-sm">
                <!-- Header -->
                <div class="absolute top-0 left-0 right-0 h-16 flex items-center justify-between px-6 bg-ink/50 backdrop-blur z-50">
                    <h2 class="font-serif text-xl text-white">{{ lightbox.currentImage?.title }}</h2>
                    <div class="flex items-center gap-4">
                        <button @click="downloadCurrentVersion" class="px-4 py-2 bg-white/10 hover:bg-gold text-white rounded-lg text-xs font-bold uppercase transition-all">
                            <i class="fas fa-download mr-2"></i>ä¸‹è½½
                        </button>
                        <button @click="closeLightbox" class="text-white/50 hover:text-white hover:rotate-90 transition-all text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Main Content: ä¸‰æ å¸ƒå±€ -->
                <div class="absolute top-16 left-0 right-0 bottom-0 flex">
                    <!-- å·¦ä¾§ï¼šç‰ˆæœ¬å†å² -->
                    <div class="w-28 bg-ink/30 backdrop-blur border-r border-white/10 overflow-y-auto">
                        <div class="p-4 space-y-3">
                            <div
                                v-for="(version, index) in posterVersions"
                                :key="version.version"
                                @click="switchVersion(index)"
                                :class="currentVersionIndex === index ? 'ring-2 ring-gold' : 'opacity-60 hover:opacity-100'"
                                class="relative cursor-pointer transition-all group"
                            >
                                <div class="aspect-[3/4] bg-white/5 rounded overflow-hidden">
                                    <img :src="version.thumbnail_url" class="w-full h-full object-cover">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸­é—´ï¼šå›¾ç‰‡é¢„è§ˆ/ç¼–è¾‘åŒº -->
                    <div class="flex-1 flex items-center justify-center p-6 relative">
                        <div class="relative max-w-full max-h-full">
                            <!-- å›¾ç‰‡ -->
                            <img
                                :id="'edit-image-' + currentVersionIndex"
                                :src="posterVersions[currentVersionIndex]?.full_url"
                                class="max-w-full max-h-[calc(100vh-10rem)] object-contain"
                                @load="onImageLoaded"
                            >
                            <!-- Canvas æ¶‚æŠ¹å±‚ï¼ˆä»…å±€éƒ¨ä¿®æ”¹æ—¶æ˜¾ç¤ºï¼‰ -->
                            <canvas
                                v-if="editType === 'partial'"
                                ref="editCanvas"
                                @mousedown="startDrawing"
                                @mousemove="draw"
                                @mouseup="stopDrawing"
                                @mouseleave="stopDrawing"
                                class="absolute top-0 left-0 cursor-crosshair"
                                style="touch-action: none;"
                            ></canvas>
                        </div>

                        <!-- ç”»ç¬”å·¥å…·æ ï¼ˆå±€éƒ¨ä¿®æ”¹æ—¶æ˜¾ç¤ºï¼‰ -->
                        <transition name="fade">
                            <div v-if="editType === 'partial'" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur rounded-lg shadow-float px-4 py-3 flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-paint-brush text-gold"></i>
                                    <span class="text-xs text-ink-light">ç”»ç¬”:</span>
                                    <input
                                        type="range"
                                        v-model="brushSize"
                                        min="10"
                                        max="100"
                                        class="w-24"
                                    >
                                    <span class="text-xs text-ink w-8">{{ brushSize }}</span>
                                </div>
                                <div class="h-6 w-px bg-stone"></div>
                                <button @click="undoCanvas" :disabled="canvasHistory.length === 0" class="p-2 hover:bg-stone/20 rounded transition-colors disabled:opacity-30">
                                    <i class="fas fa-undo text-ink"></i>
                                </button>
                                <button @click="redoCanvas" :disabled="canvasRedoStack.length === 0" class="p-2 hover:bg-stone/20 rounded transition-colors disabled:opacity-30">
                                    <i class="fas fa-redo text-ink"></i>
                                </button>
                                <button @click="clearCanvas" class="p-2 hover:bg-stone/20 rounded transition-colors">
                                    <i class="fas fa-eraser text-ink"></i>
                                </button>
                            </div>
                        </transition>
                    </div>

                    <!-- å³ä¾§ï¼šæ“ä½œé¢æ¿ -->
                    <div class="w-96 bg-paper border-l border-stone/30 overflow-y-auto">
                        <div class="p-6 space-y-6">
                            <!-- Tab åˆ‡æ¢ -->
                            <div class="flex gap-2 border-b border-stone/50 pb-4">
                                <button
                                    @click="editType = 'full'"
                                    :class="editType === 'full' ? 'bg-ink text-white' : 'bg-stone/20 text-ink-light hover:bg-stone/40'"
                                    class="flex-1 py-3 rounded-lg font-bold text-xs uppercase tracking-widest transition-all"
                                >
                                    å…¨å›¾ä¿®æ”¹
                                </button>
                                <button
                                    @click="editType = 'partial'"
                                    :class="editType === 'partial' ? 'bg-ink text-white' : 'bg-stone/20 text-ink-light hover:bg-stone/40'"
                                    class="flex-1 py-3 rounded-lg font-bold text-xs uppercase tracking-widest transition-all"
                                >
                                    å±€éƒ¨ä¿®æ”¹
                                </button>
                            </div>

                            <!-- æç¤ºè¯è¾“å…¥ -->
                            <div>
                                <label v-if="editType === 'partial'" class="block text-xs font-bold tracking-widest uppercase text-gold mb-2">
                                    è¯·åœ¨å·¦å›¾åœˆå‡ºéœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†
                                </label>
                                <label class="block text-xs font-bold tracking-widest uppercase text-gold mb-2" :class="editType === 'partial' ? 'mt-4' : ''">
                                    è¯·è¾“å…¥ä¿®æ”¹è¦æ±‚ï¼š
                                </label>
                                <textarea
                                    v-model="editPrompt"
                                    rows="4"
                                    class="w-full bg-transparent border border-stone/50 rounded-lg px-4 py-3 text-ink placeholder-stone/80 focus:ring-1 focus:ring-gold/50 focus:border-gold outline-none font-serif resize-none"
                                    placeholder="ä¾‹å¦‚ï¼šå°†èƒŒæ™¯æ”¹ä¸ºæ·±è‰²è°ƒï¼Œå¢åŠ äº§å“å…‰æ³½æ„Ÿ..."
                                ></textarea>
                            </div>

                            <!-- å‚è€ƒå›¾ä¸Šä¼  -->
                            <div>
                                <label class="block text-xs font-bold tracking-widest uppercase text-gold mb-2">
                                    æ‚¨å¯ä»¥æä¾›å‚è€ƒå›¾ï¼ˆæœ€å¤š9å¼ ï¼‰ï¼š
                                </label>
                                <div class="grid grid-cols-3 gap-2">
                                    <div
                                        v-if="editReferenceImages.length < 9"
                                        @click="$refs.editFileInput.click()"
                                        class="aspect-square border border-dashed border-gold/40 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gold/5 transition-all group hover:border-gold"
                                    >
                                        <i class="fas fa-plus text-gold/30 group-hover:text-gold text-xl"></i>
                                        <input
                                            type="file"
                                            ref="editFileInput"
                                            @change="handleEditFileChange"
                                            accept="image/*"
                                            multiple
                                            class="hidden"
                                        >
                                    </div>
                                    <div
                                        v-for="(img, idx) in editReferenceImages"
                                        :key="img.id"
                                        class="relative group aspect-square"
                                    >
                                        <img :src="img.preview" class="w-full h-full object-cover rounded-lg">
                                        <button
                                            @click="editReferenceImages.splice(idx, 1)"
                                            class="absolute -top-2 -right-2 bg-ink text-white w-6 h-6 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 hover:bg-red-500 transition-all shadow-lg"
                                        >
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- ç¼–è¾‘è¿›åº¦ -->
                            <transition name="fade">
                                <div v-if="isEditing" class="bg-gold/10 border border-gold/30 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-6 h-6 border-2 border-gold border-t-transparent rounded-full animate-spin"></div>
                                        <span class="text-sm text-gold font-serif">{{ editTaskMessage }}</span>
                                    </div>
                                    <div class="h-1 bg-stone/30 rounded-full overflow-hidden">
                                        <div
                                            class="h-full bg-gold transition-all duration-500"
                                            :style="{ width: editTaskProgress + '%' }"
                                        ></div>
                                    </div>
                                </div>
                            </transition>

                            <!-- ç§¯åˆ†è¯´æ˜ -->
                            <div class="bg-stone/20 px-3 py-2 rounded-lg text-center">
                                <p class="text-ink-light text-xs">
                                    <i class="fas fa-coins text-gold mr-1"></i>
                                    ç¼–è¾‘ä¸€å¼ å›¾éœ€è¦ <span class="text-gold font-bold">4</span> ç§¯åˆ†
                                </p>
                            </div>

                            <!-- ç¡®è®¤ä¿®æ”¹æŒ‰é’® -->
                            <button
                                @click="confirmEdit"
                                :disabled="!editPrompt || isEditing"
                                :class="!editPrompt || isEditing ? 'bg-stone text-white cursor-not-allowed' : 'bg-ink text-white hover:bg-gold hover:shadow-glow active:scale-95'"
                                class="w-full py-4 rounded-lg font-bold tracking-widest text-xs uppercase transition-all"
                            >
                                {{ isEditing ? 'ç”Ÿæˆä¸­...' : 'ç¡®è®¤ä¿®æ”¹' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
    // ========== æ¼”ç¤ºæ¨¡å¼è‡ªåŠ¨ç™»å½• ==========
    (function() {
        const DEMO_USER = {
            id: 4,
            email: "zhanbingqiang@gpulink.cc",
            credits: 10000,
            frozen: 0
        };
        const DEMO_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI0IiwiZW1haWwiOiJ6aGFuYmluZ3FpYW5nQGdwdWxpbmsuY2MiLCJleHAiOjE3NjkxNDM0MzZ9.7WRbUkjNvKVZzA_9q5hGWeI06OphFB34sMwGFOO_-bw";

        if (!localStorage.getItem('access_token')) {
            localStorage.setItem('access_token', DEMO_TOKEN);
            localStorage.setItem('user', JSON.stringify(DEMO_USER));
        }
    })();
    // ========== æ¼”ç¤ºæ¨¡å¼è‡ªåŠ¨ç™»å½•ç»“æŸ ==========

    const { createApp } = Vue;
    const API = '';
    createApp({
        data: () => ({
            view: 'list',  // 'list' or 'detail'
            currentUser: null,
            showUserMenu: false,
            userId: null,
            // åˆ—è¡¨è§†å›¾
            sessions: [],
            totalSessions: 0,
            page: 0,
            hasMore: false,
            loading: false,
            loadingMore: false,
            // è¯¦æƒ…è§†å›¾
            currentSession: null,
            generatedPosters: [],
            // ç¯ç®±
            lightbox: { isOpen: false, currentImage: null },
            posterVersions: [],
            currentVersionIndex: 0,
            editType: 'full',
            editPrompt: '',
            editReferenceImages: [],
            isEditing: false,
            editTaskProgress: 0,
            editTaskMessage: '',
            // ç¼–è¾‘åŠŸèƒ½
            editTaskId: null,
            editPoll: null,
            canvasHistory: [],
            canvasRedoStack: [],
            isDrawing: false,
            brushSize: 50
        }),
        watch: {
            // ç›‘å¬ç¼–è¾‘æ¨¡å¼åˆ‡æ¢ï¼Œå½“åˆ‡æ¢åˆ°å±€éƒ¨ä¿®æ”¹æ—¶åˆå§‹åŒ– Canvas
            editType(newType) {
                if (newType === 'partial') {
                    this.$nextTick(() => {
                        this.initCanvas();
                    });
                }
            }
        },
        computed: {
            sortedPosters() {
                return [...this.generatedPosters].sort((a, b) => parseInt(a.number) - parseInt(b.number));
            }
        },
        methods: {
            goBack() {
                if (this.view === 'detail') {
                    this.backToList();
                } else {
                    window.location.href = '/';
                }
            },
            formatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000);
                if (diff < 60) return 'åˆšåˆš';
                if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`;
                if (diff < 604800) return `${Math.floor(diff / 86400)}å¤©å‰`;
                return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            },
            async loadSessions() {
                if (!this.userId) return;
                this.loading = true;
                try {
                    const r = await fetch(`${API}/api/history/${this.userId}?page=${this.page}&page_size=20`);
                    const data = await r.json();
                    this.sessions = data.sessions || [];
                    this.totalSessions = data.total || 0;
                    this.hasMore = data.has_more || false;
                } catch (e) {
                    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥', e);
                } finally {
                    this.loading = false;
                }
            },
            async loadMore() {
                if (!this.userId) return;
                this.loadingMore = true;
                try {
                    this.page++;
                    const r = await fetch(`${API}/api/history/${this.userId}?page=${this.page}&page_size=20`);
                    const data = await r.json();
                    this.sessions.push(...(data.sessions || []));
                    this.hasMore = data.has_more || false;
                } catch (e) {
                    console.error('åŠ è½½æ›´å¤šå¤±è´¥', e);
                } finally {
                    this.loadingMore = false;
                }
            },
            async viewDetail(session) {
                this.view = 'detail';
                try {
                    const r = await fetch(`${API}/api/history/${this.userId}/${session.session_id}`);
                    const data = await r.json();
                    this.currentSession = data;
                    // è½¬æ¢ä¸ºä¸ index.html ç›¸åŒçš„æ ¼å¼
                    this.generatedPosters = (data.posters || []).map((p, i) => {
                        const num = String(p.index).padStart(2, '0');
                        return {
                            id: i,
                            number: num,
                            title: `æµ·æŠ¥${num}`,
                            mainTitle: `æµ·æŠ¥${num}`,
                            subTitle: 'ä¸»è§†è§‰',
                            filename: p.filename,
                            url: API + p.url,
                            showDownloadToast: false,
                            versionCount: p.version_count || 1
                        };
                    });
                } catch (e) {
                    console.error('åŠ è½½è¯¦æƒ…å¤±è´¥', e);
                    alert('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    this.backToList();
                }
            },
            backToList() {
                this.view = 'list';
                this.currentSession = null;
                this.generatedPosters = [];
            },
            async viewImage(p) {
                // é‡ç½®ç¼–è¾‘çŠ¶æ€
                this.editType = 'full';
                this.editPrompt = '';
                this.editReferenceImages = [];
                this.canvasHistory = [];
                this.canvasRedoStack = [];
                this.isEditing = false;

                // æ¢å¤ç”¨æˆ·ä¸Šæ¬¡é€‰æ‹©çš„ç‰ˆæœ¬ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤0
                const savedVersionIndex = p.lastVersionIndex || 0;

                // ç«‹å³ç”¨å½“å‰ç‚¹å‡»çš„æµ·æŠ¥åˆå§‹åŒ–ç‰ˆæœ¬åˆ—è¡¨ï¼Œé¿å…æ˜¾ç¤ºæ—§æ•°æ®
                this.posterVersions = [{
                    version: 0,
                    type: 'initial',
                    thumbnail_url: p.url,
                    full_url: p.url
                }];
                this.currentVersionIndex = 0;

                // æ‰“å¼€ç¯ç®±
                this.lightbox = { isOpen: true, currentImage: p };
                document.body.style.overflow = 'hidden';

                // å¼‚æ­¥åŠ è½½å®Œæ•´ç‰ˆæœ¬å†å²
                await this.loadPosterVersions(p);

                // åŠ è½½å®Œç‰ˆæœ¬åï¼Œæ¢å¤åˆ°ç”¨æˆ·ä¸Šæ¬¡é€‰æ‹©çš„ç‰ˆæœ¬
                if (savedVersionIndex > 0 && savedVersionIndex < this.posterVersions.length) {
                    this.currentVersionIndex = savedVersionIndex;
                }
            },
            closeLightbox() {
                // å…³é—­å‰ï¼Œæ›´æ–°ä¸»é¡µé¢æµ·æŠ¥å›¾ç‰‡ä¸ºå½“å‰é€‰ä¸­çš„ç‰ˆæœ¬ï¼Œå¹¶è®°ä½ç‰ˆæœ¬ç´¢å¼•
                if (this.lightbox.currentImage && this.posterVersions.length > 0) {
                    const currentVersion = this.posterVersions[this.currentVersionIndex];
                    if (currentVersion) {
                        const poster = this.generatedPosters.find(p => p.number === this.lightbox.currentImage.number);
                        if (poster) {
                            poster.url = currentVersion.full_url;
                            poster.lastVersionIndex = this.currentVersionIndex;
                        }
                    }
                }

                this.lightbox.isOpen = false;
                document.body.style.overflow = '';
                // æ¸…ç†ç¼–è¾‘è½®è¯¢
                if (this.editPoll) {
                    clearInterval(this.editPoll);
                    this.editPoll = null;
                }
            },
            async loadPosterVersions(poster) {
                const posterId = poster.number;
                try {
                    const r = await fetch(`${API}/api/edit/versions/${this.userId}/${this.currentSession.session_id}/${posterId}`);
                    if (r.ok) {
                        const data = await r.json();
                        if (data.versions && data.versions.length > 0) {
                            this.posterVersions = data.versions;
                        } else {
                            this.posterVersions = [{
                                version: 0,
                                type: 'initial',
                                thumbnail_url: poster.url,
                                full_url: poster.url
                            }];
                        }
                    } else {
                        this.posterVersions = [{
                            version: 0,
                            type: 'initial',
                            thumbnail_url: poster.url,
                            full_url: poster.url
                        }];
                    }
                } catch (e) {
                    console.error('åŠ è½½ç‰ˆæœ¬å†å²å¤±è´¥', e);
                    this.posterVersions = [{
                        version: 0,
                        type: 'initial',
                        thumbnail_url: poster.url,
                        full_url: poster.url
                    }];
                }
            },
            switchVersion(index) {
                this.currentVersionIndex = index;
                this.clearCanvas();
            },
            async downloadPoster(p) {
                try {
                    const r = await fetch(p.url);
                    const b = await r.blob();
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(b);
                    a.download = p.filename || `poster_${p.number}.jpg`;
                    a.click();
                    p.showDownloadToast = true;
                    setTimeout(() => p.showDownloadToast = false, 2000);
                } catch { alert('ä¸‹è½½å¤±è´¥'); }
            },
            async downloadAll() {
                for (const p of this.sortedPosters) {
                    await this.downloadPoster(p);
                    await new Promise(r => setTimeout(r, 300));
                }
            },
            async downloadCurrentVersion() {
                const version = this.posterVersions[this.currentVersionIndex];
                if (!version) return;
                try {
                    const r = await fetch(version.full_url);
                    const b = await r.blob();
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(b);
                    a.download = `poster_v${version.version}.jpg`;
                    a.click();
                } catch { alert('ä¸‹è½½å¤±è´¥'); }
            },
            // ========== Canvas ç¼–è¾‘åŠŸèƒ½ ==========
            onImageLoaded(e) {
                this.$nextTick(() => {
                    this.initCanvas();
                });
            },
            initCanvas() {
                const canvas = this.$refs.editCanvas;
                if (!canvas) return;

                const img = document.getElementById('edit-image-' + this.currentVersionIndex);
                if (!img) return;

                canvas.width = img.clientWidth;
                canvas.height = img.clientHeight;
                canvas.style.width = img.clientWidth + 'px';
                canvas.style.height = img.clientHeight + 'px';

                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            },
            startDrawing(e) {
                this.isDrawing = true;
                const canvas = this.$refs.editCanvas;
                const ctx = canvas.getContext('2d');

                this.canvasHistory.push(canvas.toDataURL());
                this.canvasRedoStack = [];

                const rect = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            },
            draw(e) {
                if (!this.isDrawing) return;
                const canvas = this.$refs.editCanvas;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();

                ctx.lineWidth = this.brushSize;
                ctx.strokeStyle = 'rgba(198, 142, 93, 0.5)';
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            },
            stopDrawing() {
                this.isDrawing = false;
            },
            undoCanvas() {
                if (this.canvasHistory.length === 0) return;
                const canvas = this.$refs.editCanvas;
                const ctx = canvas.getContext('2d');

                this.canvasRedoStack.push(canvas.toDataURL());
                const prevState = this.canvasHistory.pop();
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = prevState;
            },
            redoCanvas() {
                if (this.canvasRedoStack.length === 0) return;
                const canvas = this.$refs.editCanvas;
                const ctx = canvas.getContext('2d');

                this.canvasHistory.push(canvas.toDataURL());
                const nextState = this.canvasRedoStack.pop();
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = nextState;
            },
            clearCanvas() {
                const canvas = this.$refs.editCanvas;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                this.canvasHistory = [];
                this.canvasRedoStack = [];
            },
            getMarkedImage() {
                const canvas = this.$refs.editCanvas;
                const img = document.getElementById('edit-image-' + this.currentVersionIndex);
                if (!canvas || !img) return null;

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.naturalWidth;
                tempCanvas.height = img.naturalHeight;
                const ctx = tempCanvas.getContext('2d');

                ctx.drawImage(img, 0, 0);

                const scaleX = img.naturalWidth / canvas.width;
                const scaleY = img.naturalHeight / canvas.height;
                ctx.scale(scaleX, scaleY);
                ctx.drawImage(canvas, 0, 0);

                return tempCanvas.toDataURL('image/png');
            },
            handleEditFileChange(e) {
                Array.from(e.target.files).slice(0, 9 - this.editReferenceImages.length).forEach(f => {
                    const r = new FileReader();
                    r.onload = ev => this.editReferenceImages.push({
                        id: Date.now() + Math.random(),
                        file: f,
                        preview: ev.target.result
                    });
                    r.readAsDataURL(f);
                });
                e.target.value = '';
            },
            async confirmEdit() {
                if (!this.editPrompt || this.isEditing) return;

                this.isEditing = true;
                this.editTaskMessage = 'å‡†å¤‡ä¸­...';
                this.editTaskProgress = 0;

                try {
                    let sourceImage;
                    let originalImage = null;

                    if (this.editType === 'partial') {
                        sourceImage = this.getMarkedImage();
                        originalImage = this.posterVersions[this.currentVersionIndex]?.full_url;
                    } else {
                        sourceImage = this.posterVersions[this.currentVersionIndex]?.full_url;
                    }

                    const referenceImage = this.editReferenceImages.length > 0
                        ? this.editReferenceImages[0].preview
                        : null;

                    const posterId = this.lightbox.currentImage?.number || '00';

                    const response = await fetch(`${API}/api/edit/poster`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: this.userId,
                            product_id: this.currentSession.session_id,
                            poster_id: posterId,
                            edit_type: this.editType,
                            prompt: this.editPrompt,
                            source_image: sourceImage,
                            original_image: originalImage,
                            reference_image: referenceImage,
                            parent_version: this.posterVersions[this.currentVersionIndex]?.version
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'æäº¤å¤±è´¥');
                    }

                    const data = await response.json();
                    this.editTaskId = data.task_id;
                    this.editTaskMessage = 'æ­£åœ¨ç”Ÿæˆ...';

                    this.editPoll = setInterval(() => this.checkEditTask(), 2000);

                } catch (e) {
                    alert('ç¼–è¾‘å¤±è´¥: ' + e.message);
                    this.isEditing = false;
                }
            },
            async checkEditTask() {
                if (!this.editTaskId) return;

                try {
                    const r = await fetch(`${API}/api/edit/task/${this.editTaskId}`);
                    if (!r.ok) return;

                    const task = await r.json();
                    this.editTaskProgress = task.progress;
                    this.editTaskMessage = task.message;

                    if (task.status === 'completed') {
                        clearInterval(this.editPoll);
                        this.editPoll = null;
                        this.isEditing = false;

                        await this.loadPosterVersions(this.lightbox.currentImage);
                        this.currentVersionIndex = this.posterVersions.length - 1;

                        this.editPrompt = '';
                        this.editReferenceImages = [];
                        this.clearCanvas();
                    }

                    if (task.status === 'failed') {
                        clearInterval(this.editPoll);
                        this.editPoll = null;
                        this.isEditing = false;
                        alert('ç¼–è¾‘å¤±è´¥: ' + (task.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (e) {
                    console.error('æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥', e);
                }
            },
            logout() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                this.currentUser = null;
                this.userId = null;
                this.showUserMenu = false;
                window.location.href = '/login';
            }
        },
        mounted() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login';
                return;
            }
            try {
                this.currentUser = JSON.parse(userStr);
                if (this.currentUser && this.currentUser.id) {
                    this.userId = String(this.currentUser.id);
                    this.loadSessions();
                }
            } catch (e) {
                console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥', e);
                window.location.href = '/login';
            }

            // ESC å…³é—­èœå•/ç¯ç®±
            window.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    if (this.lightbox.isOpen) this.closeLightbox();
                    else if (this.showUserMenu) this.showUserMenu = false;
                }
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­ç”¨æˆ·èœå•
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-menu-container')) {
                    this.showUserMenu = false;
                }
            });
        }
    }).mount('#app');
    </script>
</body>
</html>
