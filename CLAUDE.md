你需要帮助我完成当前AI应用创意到AI应用产品的开发。需要的开发方案如下：


# 一、产品概述

基于AI的电商海报批量生成系统，用户上传产品图片和描述，自动生成一套
电商视觉海报，支持二次编辑修改。采用积分制付费。

# 二、核心规则

【积分规则】
1元 = 10积分
生成 = 4积分/张
编辑 = 4积分/张（全图/涂抹同价）

【积分流程】
生成前冻结 → 成功扣除 → 失败退回

【并发限制】
单用户同时只能有1个生成任务

【验证码】
邮箱验证码登录，1分钟有效，内存存储

# 三、数据结构

【SQLite 数据表】

- - 用户表
CREATE TABLE users (
id INTEGER PRIMARY KEY AUTOINCREMENT,
email TEXT UNIQUE NOT NULL, -- 邮箱（登录账号）
credits INTEGER DEFAULT 0, -- 可用积分
frozen INTEGER DEFAULT 0 -- 冻结积分（生成中）
);
- - 充值订单
CREATE TABLE orders (
id INTEGER PRIMARY KEY AUTOINCREMENT,
user_id INTEGER NOT NULL, -- 用户ID
amount INTEGER NOT NULL, -- 充值积分（1元=10积分）
status TEXT DEFAULT 'pending', -- pending=待支付 paid=已支付
trade_no TEXT -- 第三方支付单号
);

【文件目录结构】

data/
└── outputs/
└── {userID}/
└── session_20260110143052_a3f2/
├── productname.txt       -- 产品名称（小模型生成）
├── 00-prime.jpg          -- 01主KV视觉 原图
├── 00-edit0.jpg          -- 01主KV视觉 第1次编辑
├── 00-edit1.jpg          -- 01主KV视觉 第2次编辑
├── 02-prime.jpg          -- 03概念可视化 原图（跳过02）
└── ...

【命名规则】
sessionID:  session_{时间戳}_{4位随机数}
原图:       {序号}-prime.jpg
编辑:       {序号}-edit{n}.jpg
序号:       保持设计方案原序号（用户可跳选）

# 四、页面清单

┌─────────────────────────────────────────────────────────────────────────┐
│  1. 登录页                                                              │
├─────────────────────────────────────────────────────────────────────────┤
│  - 邮箱输入框                                                           │
│  - 验证码输入框                                                         │
│  - 发送验证码按钮（60秒倒计时）                                          │
│  - 登录按钮                                                             │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  2. 用户中心                                                            │
├─────────────────────────────────────────────────────────────────────────┤
│  - 显示积分余额（可用 / 冻结）                                           │
│  - 充值金额选择                                                         │
│  - 充值按钮 → 调起支付                                                  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  3. 首页（生成页）                                                       │
├─────────────────────────────────────────────────────────────────────────┤
│  - 上传产品图片                                                         │
│  - 输入产品描述                                                         │
│  - 海报选择器（勾选要生成哪些，默认全选）                                 │
│  - 显示预计消耗积分                                                      │
│  - 生成按钮                                                             │
│  - 生成进度展示                                                         │
│  - 结果灯箱展示（点击可进入编辑）                                        │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  4. 历史记录页1（列表）                                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  - 产品列表（时间倒序）                                                  │
│  - 每个产品显示：产品名称 + 00-prime封面图                               │
│  - 点击进入详情页                                                       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  5. 历史记录页2（详情）                                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  - 产品名称                                                             │
│  - 每行一个维度（01主KV、02生活场景...）                                 │
│  - 左侧大图（当前选中）                                                  │
│  - 右侧小图列表（prime + edit历史）                                      │
│  - 左右箭头切换，边界时隐藏                                              │
│  - 点击图片可进入编辑                                                    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  6. 编辑页（灯箱内）                                                     │
├─────────────────────────────────────────────────────────────────────────┤
│  - 主图展示                                                             │
│  - 编辑模式切换：全图修改 / 涂抹修改                                     │
│  - 提示词输入框                                                         │
│  - 参考图上传（可选）                                                    │
│  - 涂抹模式：canvas画笔工具，生成蒙版                                    │
│  - 提交编辑（扣4积分）                                                   │
└─────────────────────────────────────────────────────────────────────────┘

# 五、功能清单

【用户系统】
□ 邮箱验证码发送
□ 验证码登录（1分钟有效）
□ JWT会话管理
□ 积分余额查询
□ 充值下单
□ 支付回调处理

【生成功能】
□ 海报选择器（勾选部分生成）
□ 积分检查与冻结
□ 单用户任务锁
□ 生成成功扣积分
□ 生成失败退积分
□ 产品名称自动生成（小模型）
□ 文件按新结构保存

【编辑功能】
□ 全图修改：主图 + 提示词 + 参考图
□ 涂抹修改：canvas绘制蒙版 → 主图合成 + 提示词 + 参考图
□ 编辑结果保存为 {序号}-edit{n}.jpg

【历史记录】
□ session列表（时间倒序）
□ session详情（按维度分组）
□ 左右箭头切换
□ 点击进入编辑

# 六、积分扣除流程

用户选择生成5张（需 5×4=20 积分）
│
▼
检查 credits ≥ 20 ?
│
No ────┴──── Yes
│             │
▼             ▼
拒绝         冻结积分
提示         credits -= 20
充值         frozen += 20
│
▼
开始生成
│
┌────┬────┼────┬────┐
▼    ▼    ▼    ▼    ▼
成功  成功  失败  成功  成功
│    │    │    │    │
▼    ▼    ▼    ▼    ▼
扣4   扣4  退4   扣4   扣4
│
▼
任务完成
成功4张：扣16积分
失败1张：退4积分
frozen = 0

# 七、编辑功能逻辑

【全图修改】

输入：主图 + 提示词 + 参考图(可选)
│
▼
调用AI生成
│
▼
保存为 {序号}-edit{n}.jpg

【涂抹修改】

用户在canvas上涂抹
│
▼
生成蒙版图（涂抹区域为白色）
│
▼
主图 + 蒙版 合成为输入图
│
▼
输入图 + 提示词 + 参考图(可选)
│
▼
调用AI生成
│
▼
保存为 {序号}-edit{n}.jpg

# 八、开发顺序

Phase 1  数据结构调整
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ product_id 改成 session_{timestamp}_{random}
□ 文件名改成 {序号}-prime.jpg / {序号}-edit{n}.jpg
□ 新增 productname.txt
□ 前端同步调整

Phase 2  SQLite数据库
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ 创建数据库初始化脚本
□ 创建db.py工具类

Phase 3  用户功能
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ 验证码发送/验证
□ JWT登录
□ 积分查询
□ 充值下单/回调
□ 前端登录页 + 用户中心

Phase 4  积分hook
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ 生成前积分检查
□ 积分冻结
□ 成功扣除/失败退回
□ 单用户任务锁
□ 前端海报选择器 + 积分显示

Phase 5  图片编辑
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ 全图修改（主图+提示词+参考图）
□ 涂抹修改（canvas蒙版+主图+提示词+参考图）
□ 编辑结果保存
□ 编辑扣积分

Phase 6  历史记录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ session列表接口
□ session详情接口
□ 历史页1（列表）
□ 历史页2（详情+切换）

# 九、验证码存储

内存字典，1分钟过期：

verify_codes = {
"[test@qq.com](mailto:test@qq.com)": {
"code": "123456",
"expires": 1704872460
}
}

# 十、历史记录UI

【历史页1 - 列表】

┌──────────────────────────────────────┐
│  ← 返回            历史记录           │
├──────────────────────────────────────┤
│                                      │
│  智能手表Pro                          │
│  ┌────────────────────────┐          │
│  │                        │          │
│  │      00-prime.jpg      │          │
│  │                        │          │
│  └────────────────────────┘          │
│                                      │
│  运动耳机X1                           │
│  ┌────────────────────────┐          │
│  │                        │          │
│  │      00-prime.jpg      │          │
│  │                        │          │
│  └────────────────────────┘          │
│                                      │
└──────────────────────────────────────┘

【历史页2 - 详情】

┌──────────────────────────────────────────────────────┐
│  ← 返回              智能手表Pro                      │
├──────────────────────────────────────────────────────┤
│                                                      │
│  01 主KV视觉                              当前: 1/3  │
│  ┌────────────────────────────────────────────────┐ │
│  │                                                │ │
│  │  [隐藏]   ┌──────────────┐   [→]              │ │
│  │           │              │                    │ │
│  │           │   当前图片    │    ○ ○            │ │
│  │           │              │   小图 小图        │ │
│  │           └──────────────┘                    │ │
│  │                                                │ │
│  │   ●────○────○                                  │ │
│  │  prime edit0 edit1                            │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
│  02 生活场景                              当前: 1/1  │
│  ┌────────────────────────────────────────────────┐ │
│  │           ┌──────────────┐                    │ │
│  │           │   prime      │   (无编辑，无箭头)  │ │
│  │           └──────────────┘                    │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
└──────────────────────────────────────────────────────┘